name: CI
on:
  push:
    branches: [ main ]
    tags: [ "v*.*.*", "v*.*.*-*" ]
  pull_request:
  workflow_dispatch:

env:
  JAVA_VERSION: 17
  JAVA_DISTRO: temurin

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Define your matrix as a JSON object
          MATRIX_JSON='{
            "include": [
              {"os": "ubuntu-24.04", "arch": "x86_64", "platform": "linux/amd64", "artifact_name": "debian-binary-amd64"},
              {"os": "ubuntu-24.04-arm", "arch": "arm64", "platform": "linux/arm64", "artifact_name": "debian-binary-arm64"},
              {"os": "macos-14", "arch": "amd64", "artifact_name": "macos-binary-amd64"},
              {"os": "macos-14", "arch": "arm64", "artifact_name": "macos-binary-arm64"},
              {"os": "windows-latest", "arch": "x86_64", "artifact_name": "windows-binary-x86_64"}
            ]
          }'
          echo "matrix=$(echo $MATRIX_JSON | jq -c .)" >> $GITHUB_OUTPUT

  build-lib:
    name: Build Library (${{ matrix.artifact_name }})
    needs: setup-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      # --- Checkout and Setup ---
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRO }}
          java-version: ${{ env.JAVA_VERSION }}
      # --- Linux Build Logic ---
      - name: Docker Setup Buildx
        if: runner.os == 'Linux'
        uses: docker/setup-buildx-action@v3
      - name: Build (Linux)
        if: runner.os == 'Linux'
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --target export \
            --output type=local,dest=dist \
            .
      # --- macOS Build Logic ---
      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist/lib
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            arch -x86_64 ./build_macos.sh x86_64
          else
            ./build_macos.sh ${{ matrix.arch }}
          fi
          mv src/main/resources/macos-${{ matrix.arch }}/*.dylib dist/lib
          tar -cvf dist/piper-jni-libs.tar -C dist/lib .
      # --- Windows Build Logic ---
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          cmake -Bbuild -DCMAKE_INSTALL_PREFIX=src\main\resources\win-amd64
          cmake --build build --config Release
          cmake --install build
          if (!(Test-Path dist)) { mkdir dist }
          if (!(Test-Path dist\lib)) { mkdir dist\lib }
          move-item src\main\resources\win-amd64\*.dll .\dist\lib\
          tar -cvf dist\piper-jni-libs.tar -C dist\lib .
      # --- Upload Artifacts ---
      - name: Upload Library
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/piper-jni-libs.tar
      - name: Upload eSpeak data
        if: matrix.arch == 'x86_64' && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: espeak-ng-data
          path: dist/*.zip

  build-maven:
    name: Maven Build
    needs: build-lib
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRO }}
          java-version: ${{ env.JAVA_VERSION }}
      - uses: actions/download-artifact@v4
      - name: Setup resources
        run: |
          tar -xvf ./debian-binary-amd64/piper-jni-libs.tar -C ./src/main/resources/debian-amd64/
          tar -xvf ./debian-binary-arm64/piper-jni-libs.tar -C ./src/main/resources/debian-arm64/
          tar -xvf ./macos-binary-amd64/piper-jni-libs.tar -C ./src/main/resources/macos-amd64/
          tar -xvf ./macos-binary-arm64/piper-jni-libs.tar -C ./src/main/resources/macos-arm64/
          tar -xvf ./windows-binary-x86_64/piper-jni-libs.tar -C ./src/main/resources/win-amd64/
          mv ./espeak-ng-data/*.zip ./src/main/resources/
      - name: Bundle resources as tarball
        run: |
          mkdir -p dist
          tar -cvf dist/resources.tar -C ./src/main/resources/ .
      - name: Upload resources tarball
        uses: actions/upload-artifact@v4
        with:
          name: piper-jni-resources
          path: dist/resources.tar
      - name: Build with Maven
        run: mvn -B package -DskipTests -Dmaven.javadoc.skip=true -Dsource.skip=true
      - name: Bundle JAR as tarball
        run: |
          mkdir -p dist/target
          cp target/piper-jni-*.jar dist/target/
          rm dist/target/piper-jni-*-sources.jar
          tar -cvf dist/jar.tar -C dist/target/ .
      - name: Upload JAR tarball
        uses: actions/upload-artifact@v4
        with:
          name: piper-jni
          path: dist/jar.tar
      - name: Download models for tests
        run: ./download_test_model.sh
      - name: Run tests
        run: mvn -B test

  test-maven:
    name: Maven Test (${{ matrix.artifact_name }})
    needs: [setup-matrix, build-maven]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRO }}
          java-version: ${{ env.JAVA_VERSION }}
      - uses: actions/download-artifact@v4
        with:
          name: piper-jni-resources
          path: dist/
      - name: Extract resources tarball
        run: tar -xvf dist/resources.tar -C ./src/main/resources/
      - name: Download models
        run: ./download_test_model.sh
      - name: Run Maven Tests
        shell: bash
        run: |
          # Use -DforkCount=0 to run tests in the same process as Maven.
          # This avoids the "Abort trap 6" caused by the fork losing library context.
          # Also explicitly set the native library path just in case.
          COMMON_OPTS="-B -DforkCount=0 -Ddebug.piper.jni=true"

          # Specific check for macOS Intel on ARM runner
          if [[ "${{ runner.os }}" == "macOS" && "${{ matrix.arch }}" == "amd64" ]]; then
            echo "Running tests via Rosetta for x86_64"
            arch -x86_64 mvn $COMMON_OPTS test
          else
            mvn $COMMON_OPTS test
          fi

  deploy:
    name: Deploy to Maven Central
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-maven
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      # Download the final JAR built in the build-maven job
      - name: Download Maven JAR
        uses: actions/download-artifact@v4
        with:
          name: piper-jni
          path: target/
      - name: Set up Maven Central Repository
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'
          server-id: sonatype-nexus-staging
          server-username: MAVEN_USERNAME
          server-password: MAVEN_CENTRAL_TOKEN
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
      - name: Deploy with Maven
        id: deploy
        run: |
          mvn -B clean deploy -DskipTests -Pci-cd
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          PIPER_VERSION=$(echo "${VERSION%%"-"*}")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "PIPER_VERSION=$PIPER_VERSION" >> $GITHUB_OUTPUT
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
      - name: Release
        uses: softprops/action-gh-release@v1
        id: create_release
        with:
          tag_name: piper_jni_${{ steps.deploy.outputs.VERSION }}
          name: piperJNI v${{ steps.deploy.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: A JNI wrapper for piper v${{ steps.deploy.outputs.PIPER_VERSION }}
          files: |
            target/piper-jni-${{ steps.deploy.outputs.VERSION }}.jar
        env:
          GITHUB_TOKEN: ${{ github.token }}
