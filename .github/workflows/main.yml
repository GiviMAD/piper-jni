name: CI
on:
  push:
    branches: [ main ]
    tags: [ "v*.*.*", "v*.*.*-*" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-lib:
    name: Build Library ${{ matrix.artifact_name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            arch: x86_64
            platform: linux/amd64
            artifact_name: debian-binary-amd64
            path_suffix: debian-amd64
          # Linux arm64
          - os: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64
            artifact_name: debian-binary-arm64
            path_suffix: debian-arm64
          # Linux armv7l (Using QEMU on x86 runner is usually more stable than the arm runner for v7)
          - os: ubuntu-latest
            arch: armv7l
            platform: linux/arm/v7
            artifact_name: debian-binary-armv7l
            path_suffix: debian-armv7l
          # macOS Intel
          - os: macos-13
            arch: amd64
            artifact_name: macos-binary-amd64
          # macOS Apple Silicon
          - os: macos-latest
            arch: arm64
            artifact_name: macos-binary-arm64
          # Windows x86_64
          - os: windows-latest
            arch: x86_64
            artifact_name: windows-binary-x86_64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # Only need QEMU if we are on x86 building for ARM (unlikely with this setup)
      # or if the ARM64 runner needs extra help with v7 instructions.
      - name: Set up QEMU
        if: runner.os == 'Linux' && matrix.arch == 'armv7l'
        uses: docker/setup-qemu-action@v3

      - name: Docker Setup Buildx
        if: runner.os == 'Linux'
        uses: docker/setup-buildx-action@v3

      # --- Linux Build Logic (Handles x86_64, arm64, and armv7l) ---
      - name: Build (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p dist
          docker build --platform ${{ matrix.platform }} -f Dockerfile . -t piperjni_binary --load
          docker run --platform ${{ matrix.platform }} -v $(pwd)/dist:/out piperjni_binary sh -c "cp /*.so* /out/ && (cp /*.ort /out/ 2>/dev/null || true) && (cp /*.zip /out/ 2>/dev/null || true)"

      # --- macOS & Windows Logic remains same as previous ---
      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist
          ./build_macos.sh ${{ matrix.arch }}
          mv src/main/resources/macos-${{ matrix.arch }}/*.dylib dist/

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          cmake -Bbuild -DCMAKE_INSTALL_PREFIX=src\main\resources\win-amd64
          cmake --build build --config Release
          cmake --install build
          if (!(Test-Path dist)) { mkdir dist }
          move-item src\main\resources\win-amd64\*.dll .\dist\

      - name: Upload Library
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/*.so*
            dist/*.dylib
            dist/*.dll

      - name: Upload Shared Assets
        if: matrix.arch == 'x86_64' && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: shared-assets
          path: |
            dist/*.zip
            dist/*.ort
